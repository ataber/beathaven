$ ->
  Stripe.setPublishableKey("<%= ENV["STRIPE_PUBLISHABLE_KEY"] %>")

  validateForm = ->
    $("#performer-form").validate({
      errorClass: "text-danger",
      rules: {
        legal_billing_name: "required",
        routing_number: "required",
        account_number: "required",
        billing_email: {
          required: true,
          email: true
        }
      },
      messages: {
        legal_billing_name: "Please specify legal billing name",
        routing_number: "Please specify routing number",
        account_number: "Please specify account number",
        billing_email: {
          required: "Please specify billing email",
          email: 'Billing email must be in email format'
        }
      },
      submitHandler: submitHandler
    })

  submitHandler = (form) ->
    $("#performer-submit").prop("disable", true)
    routingNumber = $(".routing-number").val()
    accountNumber = $(".account-number").val()
    Stripe.bankAccount.createToken({
      country: "US",
      routingNumber: routingNumber,
      accountNumber: accountNumber
    }, stripeResponseHandler)

  stripeResponseHandler = (status, response) ->
    if response.error
      $("#performer-submit").prop("disable", false)
      $(".payment-errors").text(response.error.message)
    else
      payment_form = $("#performer-form")
      token = response["id"]
      payment_form.append($("<input type='hidden' name='stripeToken' />").val(token))
      payment_form.get(0).submit()

  validateForm()
